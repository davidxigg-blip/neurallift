<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GymTrack Pro - Final Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        window.FB = { initializeApp, getAuth, onAuthStateChanged, signInWithEmailAndPassword, signInAnonymously, signOut, getFirestore, collection, addDoc, onSnapshot, query, orderBy, Timestamp };
    </script>

    <style>
        body { background-color: #050505; color: #f4f4f5; font-family: sans-serif; overflow-x: hidden; }
        .glass { background: rgba(24, 24, 27, 0.7); backdrop-filter: blur(14px); border: 1px solid rgba(63, 63, 70, 0.4); }
        /* Fix para que los iconos no bloqueen el click del botón */
        i[data-lucide] { pointer-events: none; display: inline-block; }
        button { cursor: pointer; -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyB5TTnMn1co3GA_oX3jrZ5KZ8KzRbXbhGQ",
            authDomain: "gym-pro-4588d.firebaseapp.com",
            projectId: "gym-pro-4588d",
            storageBucket: "gym-pro-4588d.firebasestorage.app",
            messagingSenderId: "177629353240",
            appId: "1:177629353240:web:3a7b3f73d05c9468347a6d"
        };

        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [routines, setRoutines] = useState([]);
            const [workouts, setWorkouts] = useState([]);
            const [currentWorkout, setCurrentWorkout] = useState(null);
            const [restTime, setRestTime] = useState(0);
            const [isAddingRoutine, setIsAddingRoutine] = useState(false);
            const [newRoutine, setNewRoutine] = useState({ name: '', exercises: [''] });

            // 1. Inicializar Firebase
            useEffect(() => {
                const checkFB = setInterval(() => {
                    if (window.FB) {
                        clearInterval(checkFB);
                        const app = window.FB.initializeApp(firebaseConfig);
                        const auth = window.FB.getAuth(app);
                        window.FB.onAuthStateChanged(auth, (u) => {
                            setUser(u);
                            setLoading(false);
                        });
                    }
                }, 100);
            }, []);

            // 2. Escuchar cambios de Tab para refrescar iconos de Lucide
            useEffect(() => {
                if (window.lucide) {
                    setTimeout(() => window.lucide.createIcons(), 100);
                }
            }, [activeTab, user, isAddingRoutine, currentWorkout, loading]);

            // 3. Carga de datos
            useEffect(() => {
                if (!user) return;
                const db = window.FB.getFirestore();
                const unsubR = window.FB.onSnapshot(window.FB.collection(db, "users", user.uid, "routines"), (snap) => {
                    setRoutines(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                const unsubW = window.FB.onSnapshot(window.FB.collection(db, "users", user.uid, "workouts"), (snap) => {
                    setWorkouts(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });
                return () => { unsubR(); unsubW(); };
            }, [user]);

            useEffect(() => {
                let timer;
                if (restTime > 0) timer = setInterval(() => setRestTime(prev => prev - 1), 1000);
                return () => clearInterval(timer);
            }, [restTime]);

            const saveRoutine = async () => {
                const db = window.FB.getFirestore();
                await window.FB.addDoc(window.FB.collection(db, "users", user.uid, "routines"), {
                    name: newRoutine.name || "Sin nombre",
                    exercises: newRoutine.exercises.filter(e => e.trim() !== '')
                });
                setIsAddingRoutine(false);
                setNewRoutine({ name: '', exercises: [''] });
            };

            const finishWorkout = async () => {
                const db = window.FB.getFirestore();
                await window.FB.addDoc(window.FB.collection(db, "users", user.uid, "workouts"), {
                    ...currentWorkout,
                    date: window.FB.Timestamp.now()
                });
                setCurrentWorkout(null);
                setActiveTab('dashboard');
            };

            if (loading) return <div className="h-screen flex items-center justify-center font-black italic text-lime-400 animate-pulse uppercase tracking-tighter">GymTrack Pro...</div>;
            if (!user) return <AuthScreen />;

            return (
                <div className="max-w-md mx-auto min-h-screen p-6 pb-32">
                    <header className="flex justify-between items-center mb-8">
                        <div className="flex items-center gap-2">
                            <div className="bg-lime-400 p-2 rounded-lg text-black shadow-lg shadow-lime-400/20"><i data-lucide="zap"></i></div>
                            <h1 className="font-black italic text-xl tracking-tighter uppercase">GymTrack</h1>
                        </div>
                        <button onClick={() => window.FB.signOut(window.FB.getAuth())} className="text-zinc-600 p-2"><i data-lucide="log-out"></i></button>
                    </header>

                    {restTime > 0 && (
                        <div className="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center">
                            <h2 className="text-8xl font-black italic text-lime-400">{restTime}s</h2>
                            <p className="text-zinc-500 uppercase font-bold tracking-widest mt-4">Descanso</p>
                            <button onClick={() => setRestTime(0)} className="mt-8 border border-zinc-700 px-8 py-3 rounded-full text-xs font-bold uppercase">Omitir</button>
                        </div>
                    )}

                    <main>
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <div className="flex justify-between items-end">
                                    <h3 className="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Protocolos</h3>
                                    <button onClick={() => setIsAddingRoutine(true)} className="text-lime-400 text-[10px] font-black uppercase tracking-widest">Crear Nuevo</button>
                                </div>
                                {routines.map(r => (
                                    <div key={r.id} onClick={() => {
                                        setCurrentWorkout({ routineName: r.name, exercises: r.exercises.map(ex => ({ name: ex, sets: [{w:'', r:'', c:false}] })) });
                                        setActiveTab('active');
                                    }} className="glass p-6 rounded-[2rem] active:scale-[0.98] transition-all flex justify-between items-center">
                                        <div>
                                            <h4 className="text-xl font-black italic uppercase leading-none">{r.name}</h4>
                                            <p className="text-zinc-500 text-[10px] font-bold uppercase mt-1">{r.exercises.length} ejercicios</p>
                                        </div>
                                        <div className="text-lime-400/30"><i data-lucide="play" fill="currentColor"></i></div>
                                    </div>
                                ))}
                            </div>
                        )}

                        {activeTab === 'active' && currentWorkout && (
                            <div className="space-y-6 animate-in slide-in-from-bottom-4 duration-500">
                                <div className="flex justify-between items-center bg-zinc-900 p-4 rounded-2xl border border-lime-400/10">
                                    <h2 className="font-black italic text-lime-400 uppercase">{currentWorkout.routineName}</h2>
                                    <button onClick={finishWorkout} className="bg-lime-400 text-black px-4 py-1.5 rounded-xl font-black text-[10px]">FINALIZAR</button>
                                </div>
                                {currentWorkout.exercises.map((ex, exIdx) => (
                                    <div key={exIdx} className="glass p-5 rounded-3xl space-y-4">
                                        <h3 className="font-black italic text-sm uppercase text-white/90">{ex.name}</h3>
                                        {ex.sets.map((s, sIdx) => (
                                            <div key={sIdx} className="flex gap-2 items-center">
                                                <div className="w-5 text-[10px] font-black text-zinc-700 italic">{sIdx + 1}</div>
                                                <input type="number" placeholder="Kg" className="w-full bg-zinc-900 rounded-xl p-3 text-center font-bold text-sm" onChange={(e) => {
                                                    const copy = {...currentWorkout};
                                                    copy.exercises[exIdx].sets[sIdx].w = e.target.value;
                                                    setCurrentWorkout(copy);
                                                }} />
                                                <input type="number" placeholder="Reps" className="w-full bg-zinc-900 rounded-xl p-3 text-center font-bold text-sm" onChange={(e) => {
                                                    const copy = {...currentWorkout};
                                                    copy.exercises[exIdx].sets[sIdx].r = e.target.value;
                                                    setCurrentWorkout(copy);
                                                }} />
                                                <button onClick={() => {
                                                    const copy = {...currentWorkout};
                                                    const set = copy.exercises[exIdx].sets[sIdx];
                                                    set.c = !set.c;
                                                    setCurrentWorkout(copy);
                                                    if(set.c) setRestTime(60);
                                                }} className={`w-14 h-11 rounded-xl flex items-center justify-center transition-all ${s.c ? 'bg-lime-400 text-black shadow-lg shadow-lime-400/20' : 'bg-zinc-800 text-zinc-600'}`}>
                                                    <i data-lucide="check" style={{width: 18}}></i>
                                                </button>
                                            </div>
                                        ))}
                                        <button onClick={() => {
                                            const copy = {...currentWorkout};
                                            copy.exercises[exIdx].sets.push({w:'', r:'', c:false});
                                            setCurrentWorkout(copy);
                                        }} className="w-full py-2 border border-dashed border-zinc-800 rounded-xl text-[8px] font-black text-zinc-600 uppercase">+ Añadir Serie</button>
                                    </div>
                                ))}
                            </div>
                        )}
                        
                        {activeTab === 'history' && (
                           <div className="space-y-4 animate-in fade-in duration-500">
                                <h3 className="text-[10px] font-black text-zinc-500 uppercase tracking-widest">Registros Anteriores</h3>
                                {workouts.length === 0 && <p className="text-center text-zinc-700 italic text-sm py-10">Historial vacío</p>}
                                {workouts.sort((a,b) => (b.date?.seconds || 0) - (a.date?.seconds || 0)).map(w => (
                                    <div key={w.id} className="glass p-5 rounded-[1.5rem] flex justify-between items-center">
                                        <div>
                                            <p className="text-[8px] font-bold text-lime-400 uppercase">{w.date?.toDate().toLocaleDateString()}</p>
                                            <h4 className="font-black italic uppercase text-md">{w.routineName}</h4>
                                        </div>
                                        <div className="bg-zinc-800 p-2 rounded-lg text-zinc-500"><i data-lucide="award" style={{width: 16}}></i></div>
                                    </div>
                                ))}
                           </div>
                        )}
                    </main>

                    <nav className="fixed bottom-6 left-6 right-6 glass rounded-[2.5rem] p-2 flex justify-around items-center z-50">
                        <button onClick={() => setActiveTab('dashboard')} className={`p-4 transition-all ${activeTab === 'dashboard' ? 'text-lime-400 scale-110' : 'text-zinc-600'}`}><i data-lucide="layout-dashboard"></i></button>
                        <button onClick={() => setActiveTab('history')} className={`p-4 transition-all ${activeTab === 'history' ? 'text-lime-400 scale-110' : 'text-zinc-600'}`}><i data-lucide="history"></i></button>
                        <button onClick={() => currentWorkout ? setActiveTab('active') : setIsAddingRoutine(true)} className={`w-12 h-12 rounded-full flex items-center justify-center transition-all ${currentWorkout ? 'bg-lime-400 text-black shadow-lg shadow-lime-400/30' : 'bg-zinc-800 text-zinc-500 hover:text-white'}`}>
                            <i data-lucide={currentWorkout ? "flame" : "plus"}></i>
                        </button>
                    </nav>

                    {isAddingRoutine && (
                        <div className="fixed inset-0 z-[110] bg-black/98 p-8 overflow-y-auto">
                            <div className="max-w-xs mx-auto space-y-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h2 className="text-2xl font-black italic uppercase text-lime-400">Nuevo Protocolo</h2>
                                    <button onClick={() => setIsAddingRoutine(false)} className="bg-zinc-900 p-2 rounded-full"><i data-lucide="x"></i></button>
                                </div>
                                <input placeholder="Nombre (Ej: Empuje A)" className="w-full bg-zinc-900 p-5 rounded-2xl font-bold border border-zinc-800 focus:border-lime-400 outline-none" value={newRoutine.name} onChange={e => setNewRoutine({...newRoutine, name: e.target.value})} />
                                <div className="space-y-3">
                                    <p className="text-[10px] font-black text-zinc-600 uppercase tracking-widest">Ejercicios</p>
                                    {newRoutine.exercises.map((ex, i) => (
                                        <input key={i} placeholder={`Nombre del ejercicio`} className="w-full bg-zinc-900/50 p-4 rounded-xl text-sm border border-zinc-800" value={ex} onChange={e => {
                                            const exs = [...newRoutine.exercises];
                                            exs[i] = e.target.value;
                                            setNewRoutine({...newRoutine, exercises: exs});
                                        }} />
                                    ))}
                                </div>
                                <button onClick={() => setNewRoutine({...newRoutine, exercises: [...newRoutine.exercises, '']})} className="w-full py-4 border border-dashed border-zinc-800 rounded-2xl text-[9px] font-black text-zinc-500 uppercase">+ Otro Movimiento</button>
                                <button onClick={saveRoutine} className="w-full bg-lime-400 text-black p-5 rounded-[2rem] font-black italic text-lg shadow-xl shadow-lime-400/20">CONFIRMAR Y GUARDAR</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function AuthScreen() {
            const [email, setEmail] = useState('');
            const [pass, setPass] = useState('');
            const [loading, setLoading] = useState(false);

            const handleAuth = async () => {
                setLoading(true);
                try {
                    await window.FB.signInWithEmailAndPassword(window.FB.getAuth(), email, pass);
                } catch (e) {
                    alert("Error: " + e.message);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="h-screen flex items-center justify-center p-8 bg-[#050505]">
                    <div className="glass w-full p-10 rounded-[3rem] space-y-8 text-center animate-in zoom-in duration-500">
                        <div>
                            <div className="w-16 h-16 bg-lime-400 rounded-2xl mx-auto flex items-center justify-center text-black mb-4 shadow-2xl shadow-lime-400/20"><i data-lucide="zap" style={{width: 32, height: 32}}></i></div>
                            <h2 className="text-4xl font-black italic tracking-tighter uppercase leading-none">GymTrack</h2>
                            <p className="text-[9px] font-black text-zinc-500 tracking-[0.4em] uppercase mt-2">Personal Training Pro</p>
                        </div>
                        <div className="space-y-3 text-left">
                            <input className="w-full bg-zinc-900/80 border border-zinc-800 p-5 rounded-2xl text-sm outline-none focus:border-lime-400 transition-all" placeholder="Email" onChange={e => setEmail(e.target.value)} />
                            <input className="w-full bg-zinc-900/80 border border-zinc-800 p-5 rounded-2xl text-sm outline-none focus:border-lime-400 transition-all" type="password" placeholder="Contraseña" onChange={e => setPass(e.target.value)} />
                        </div>
                        <button onClick={handleAuth} className="w-full bg-lime-400 text-black p-5 rounded-[2rem] font-black italic text-xl shadow-xl shadow-lime-400/20 active:scale-95 transition-all">
                            {loading ? "CARGANDO..." : "INICIAR SESIÓN"}
                        </button>
                        <button onClick={() => window.FB.signInAnonymously(window.FB.getAuth())} className="text-zinc-600 text-[9px] font-black uppercase tracking-widest hover:text-zinc-400">Entrar como invitado</button>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
